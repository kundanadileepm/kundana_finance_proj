---
- name: Install Docker, Prometheus, and Grafana
  hosts: monitoring
  become: true

  vars:
    prometheus_version: "2.52.0"

  tasks:

  #### ----------------------
  #### 1. Install Docker
  #### ----------------------
  - name: Install apt dependencies for Docker
    apt:
      name:
        - apt-transport-https
        - ca-certificates
        - curl
        - gnupg
        - lsb-release
      state: present
      update_cache: yes

  - name: Add Dockerâ€™s official GPG key
    apt_key:
      url: https://download.docker.com/linux/ubuntu/gpg
      state: present

  - name: Set up Docker repository
    apt_repository:
      repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu jammy stable
      state: present

  - name: Install Docker Engine
    apt:
      name:
        - docker-ce
        - docker-ce-cli
        - containerd.io
      state: present
      update_cache: yes

  - name: Enable and start Docker
    systemd:
      name: docker
      enabled: true
      state: started

  #### ----------------------
  #### 2. Install Prometheus
  #### ----------------------
  - name: Create prometheus user
    user:
      name: prometheus
      shell: /sbin/nologin

  - name: Ensure Prometheus directories exist
    file:
      path: "{{ item }}"
      state: directory
      owner: prometheus
      group: prometheus
    loop:
      - /etc/prometheus
      - /var/lib/prometheus
      - /opt/prometheus

  - name: Download Prometheus tarball
    get_url:
      url: "https://github.com/prometheus/prometheus/releases/download/v{{ prometheus_version }}/prometheus-{{ prometheus_version }}.linux-amd64.tar.gz"
      dest: /tmp/prometheus.tar.gz

  - name: Extract Prometheus binaries
    unarchive:
      src: /tmp/prometheus.tar.gz
      dest: /opt/prometheus
      remote_src: yes
      extra_opts: [--strip-components=1]

  - name: Copy Prometheus binaries to /usr/local/bin
    copy:
      src: "/opt/prometheus/{{ item }}"
      dest: "/usr/local/bin/{{ item }}"
      mode: '0755'
      remote_src: yes
    loop:
      - prometheus
      - promtool

  - name: Copy Prometheus config
    copy:
      src: /opt/prometheus/prometheus.yml
      dest: /etc/prometheus/prometheus.yml
      owner: prometheus
      group: prometheus

  - name: Create Prometheus systemd service
    copy:
      dest: /etc/systemd/system/prometheus.service
      content: |
        [Unit]
        Description=Prometheus Monitoring
        After=network.target

        [Service]
        User=prometheus
        ExecStart=/usr/local/bin/prometheus \
          --config.file=/etc/prometheus/prometheus.yml \
          --storage.tsdb.path=/var/lib/prometheus/ \
          --web.listen-address=:9090
        Restart=on-failure

        [Install]
        WantedBy=multi-user.target

  - name: Reload and start Prometheus
    systemd:
      daemon_reload: yes
      name: prometheus
      enabled: true
      state: started

  #### ----------------------
  #### 3. Install Grafana
  #### ----------------------
  - name: Add Grafana GPG key and repo
    block:
      - name: Create keyrings dir
        file:
          path: /etc/apt/keyrings/
          state: directory

      - name: Add Grafana GPG key
        shell: |
          wget -q -O - https://apt.grafana.com/gpg.key | gpg --dearmor | tee /etc/apt/keyrings/grafana.gpg > /dev/null
        args:
          executable: /bin/bash

      - name: Add Grafana repository
        apt_repository:
          repo: "deb [signed-by=/etc/apt/keyrings/grafana.gpg] https://apt.grafana.com stable main"
          filename: grafana
          state: present

  - name: Install Grafana
    apt:
      name: grafana
      state: present
      update_cache: yes

  - name: Enable and start Grafana
    systemd:
      name: grafana-server
      enabled: true
      state: started
